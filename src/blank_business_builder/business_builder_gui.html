<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Builder - Autonomous Enterprise Onboarding</title>
    <style>
        :root {
            --primary: #00ff88;
            --primary-dark: #00cc6a;
            --secondary: #00bfff;
            --bg-dark: #0a0e27;
            --bg-card: #151933;
            --text: #e8eaf6;
            --text-dim: #9fa8da;
            --border: #283593;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1f3a 100%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
            flex: 1;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        /* Wizard Styles */
        .wizard-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3rem;
            position: relative;
        }

        .wizard-progress::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border);
            z-index: 0;
            transform: translateY(-50%);
        }

        .step-indicator {
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            font-weight: bold;
            color: var(--text-dim);
            transition: all 0.3s ease;
        }

        .step-indicator.active {
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .step-indicator.completed {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg-dark);
        }

        .step-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Elements */
        .form-group { margin-bottom: 1.5rem; }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        .btn {
            padding: 0.8rem 2rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: 8px;
            color: var(--bg-dark);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        .btn-outline:hover { background: rgba(0, 255, 136, 0.1); }

        /* Specific Views */
        .service-item {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.03);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .service-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 1rem;
        }

        .console-log {
            background: #000;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            color: var(--primary);
            height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .business-option {
            border: 1px solid var(--border);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-card);
        }

        .business-option:hover {
            border-color: var(--primary);
            background: rgba(0, 255, 136, 0.05);
        }

        .business-option.selected {
            border-color: var(--primary);
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .pricing-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .pricing-card.featured {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.1);
        }

        .price { font-size: 2.5rem; font-weight: bold; margin: 1rem 0; color: var(--text); }
        .price span { font-size: 1rem; color: var(--text-dim); font-weight: normal; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .metric-card {
            background: rgba(0,0,0,0.2);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-val { font-size: 2rem; font-weight: bold; color: var(--primary); }
        .metric-label { color: var(--text-dim); font-size: 0.9rem; margin-top: 0.5rem; }

        /* Admin Bypass */
        .admin-bypass {
            margin-top: 2rem;
            text-align: right;
            font-size: 0.8rem;
            color: var(--text-dim);
        }
        .bypass-input {
            display: none;
            margin-top: 0.5rem;
        }
        .bypass-input.visible { display: block; }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Business Builder OS</h1>
            <p style="color: var(--text-dim);">Autonomous Enterprise Deployment System</p>
        </header>

        <!-- WIZARD CONTAINER -->
        <div id="wizard-container">
            <div class="wizard-progress">
                <div class="step-indicator active" id="ind-1">1</div>
                <div class="step-indicator" id="ind-2">2</div>
                <div class="step-indicator" id="ind-3">3</div>
                <div class="step-indicator" id="ind-4">4</div>
                <div class="step-indicator" id="ind-5">5</div>
                <div class="step-indicator" id="ind-6">6</div>
            </div>

            <!-- Step 1: Profile -->
            <div class="step-content active" id="step-1">
                <div class="card">
                    <h2>üë§ Founder Profile</h2>
                    <p class="subtitle">Let's get your details to personalize the deployment.</p>
                    <br>
                    <form id="profileForm">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="founderName" required>
                        </div>
                        <div class="form-group">
                            <label>Mailing Address</label>
                            <input type="text" id="address" placeholder="Street Address" required>
                        </div>
                        <div class="form-group">
                            <label>State of Operation</label>
                            <input type="text" id="locationState" placeholder="e.g. California" required>
                        </div>
                        <div class="form-group">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label>Weekly Hours Available</label>
                                    <input type="number" id="weeklyHours" value="20" required>
                                </div>
                                <div>
                                    <label>Startup Budget ($)</label>
                                    <input type="number" id="startupBudget" value="5000" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Preferred Industry</label>
                            <select id="preferredIndustry">
                                <option value="Generalist">Open to Recommendations (Generalist)</option>
                                <option value="Technology">Technology</option>
                                <option value="Ecommerce">Ecommerce</option>
                                <option value="Finance">Finance</option>
                                <option value="Services">Services</option>
                            </select>
                        </div>
                        <button type="button" class="btn" onclick="submitProfile()">Next Step ‚Üí</button>
                    </form>
                </div>
            </div>

            <!-- Step 2: Legal / EIN -->
            <div class="step-content" id="step-2">
                <div class="card">
                    <h2>üèõÔ∏è Legal Registration</h2>
                    <p>You need a Federal Tax ID (EIN) to operate. Registration is free on the IRS website.</p>

                    <div style="background: rgba(0, 191, 255, 0.1); padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; border-left: 4px solid var(--secondary);">
                        <strong>Instructions:</strong>
                        <ol style="margin-left: 1.5rem; margin-top: 0.5rem;">
                            <li>Click the button below to open the IRS EIN Assistant.</li>
                            <li>Complete the application (takes ~5 minutes).</li>
                            <li>Download your EIN Confirmation Letter (PDF).</li>
                            <li>Return here and confirm you have your EIN.</li>
                        </ol>
                    </div>

                    <a href="https://www.irs.gov/businesses/small-businesses-self-employed/apply-for-an-employer-identification-number-ein-online"
                       target="_blank" class="btn btn-outline" style="display: block; text-align: center; margin-bottom: 1.5rem;">
                        Open IRS.gov EIN Application ‚Üó
                    </a>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="einConfirmed" onchange="toggleStep2Btn()">
                            I have received my EIN and saved the documentation.
                        </label>
                    </div>

                    <button type="button" class="btn" id="btn-step-2" disabled onclick="nextStep(3)">Next Step ‚Üí</button>
                </div>
            </div>

            <!-- Step 3: Service Setup -->
            <div class="step-content" id="step-3">
                <div class="card">
                    <h2>üîå Service Integrations</h2>
                    <p>We need to connect these services to enable autonomous operations.</p>
                    <br>

                    <div class="service-item">
                        <input type="checkbox" class="svc-check">
                        <div style="flex:1">
                            <strong>Stripe</strong> - For processing payments.
                            <br><a href="https://dashboard.stripe.com/register" target="_blank" style="color: var(--secondary); font-size: 0.9rem;">Sign Up ‚Üó</a>
                        </div>
                    </div>

                    <div class="service-item">
                        <input type="checkbox" class="svc-check">
                        <div style="flex:1">
                            <strong>Twilio</strong> - For SMS and voice capabilities.
                            <br><a href="https://www.twilio.com/try-twilio" target="_blank" style="color: var(--secondary); font-size: 0.9rem;">Sign Up ‚Üó</a>
                        </div>
                    </div>

                    <div class="service-item">
                        <input type="checkbox" class="svc-check">
                        <div style="flex:1">
                            <strong>ElevenLabs</strong> - For realistic AI voice generation.
                            <br><a href="https://elevenlabs.io/sign-up" target="_blank" style="color: var(--secondary); font-size: 0.9rem;">Sign Up ‚Üó</a>
                        </div>
                    </div>

                    <div class="service-item">
                        <input type="checkbox" class="svc-check">
                        <div style="flex:1">
                            <strong>Professional Email</strong> - (e.g. Google Workspace or Zoho).
                            <br><small style="color: var(--text-dim);">Main contact for all businesses.</small>
                        </div>
                    </div>

                    <button type="button" class="btn" onclick="nextStep(4)">Next Step ‚Üí</button>
                </div>
            </div>

            <!-- Step 4: OSINT Research -->
            <div class="step-content" id="step-4">
                <div class="card">
                    <h2>üïµÔ∏è Market Analysis & OSINT</h2>
                    <p>Agents are scanning local data and global trends to find the best opportunities.</p>
                    <br>
                    <div class="console-log" id="osintLog">
                        > Initializing OSINT agents...<br>
                    </div>
                    <div id="researchProgress" style="width: 0%; height: 4px; background: var(--primary); transition: width 2s ease;"></div>
                    <br>
                    <button type="button" class="btn" id="btn-research" onclick="startResearch()">Start Analysis</button>
                </div>
            </div>

            <!-- Step 5: Selection -->
            <div class="step-content" id="step-5">
                <div class="card">
                    <h2>üéØ Select Your Business</h2>
                    <p>Based on our analysis, these are the top automated businesses for you.</p>
                    <br>
                    <div id="recommendations-list">
                        <!-- Populated by JS -->
                        <p style="text-align: center;">Loading recommendations...</p>
                    </div>
                    <input type="hidden" id="selectedBusiness">
                    <button type="button" class="btn" id="btn-select" disabled onclick="nextStep(6)">Confirm Selection ‚Üí</button>
                </div>
            </div>

            <!-- Step 6: Licensing -->
            <div class="step-content" id="step-6">
                <div class="card">
                    <h2>üìù Licensing & Revenue Agreement</h2>
                    <p>Choose your operating model. This choice is final for the contract duration.</p>

                    <div class="pricing-grid">
                        <!-- Partner Tier -->
                        <div class="pricing-card featured" onclick="selectTier('partner')" id="card-partner">
                            <h3>Partner Tier</h3>
                            <div class="price">$0 <span>/ upfront</span></div>
                            <p style="color: var(--primary); font-weight: bold; margin-bottom: 1rem;">50% Revenue Share</p>
                            <ul style="text-align: left; margin-bottom: 1.5rem; color: var(--text-dim); list-style: none;">
                                <li>‚úì Instant Setup</li>
                                <li>‚úì No Capital Risk</li>
                                <li>‚úì Full Automation Suite</li>
                                <li>‚ö† <strong>Platform takes 50% of profit</strong></li>
                                <li>‚ö† <strong>Locked: No switching later</strong></li>
                            </ul>
                            <button class="btn btn-outline" style="width: 100%;">Select Partner</button>
                        </div>

                        <!-- Paid Tier -->
                        <div class="pricing-card" onclick="selectTier('paid')" id="card-paid">
                            <h3>Owner Tier</h3>
                            <div class="price">$5,000 <span>/ year</span></div>
                            <p style="color: var(--secondary); font-weight: bold; margin-bottom: 1rem;">100% You Keep It</p>
                            <ul style="text-align: left; margin-bottom: 1.5rem; color: var(--text-dim); list-style: none;">
                                <li>‚úì Full Ownership</li>
                                <li>‚úì You Keep 100% Profit</li>
                                <li>‚úì Priority Support</li>
                                <li>‚úì Advanced Analytics</li>
                            </ul>
                            <button class="btn btn-outline" style="width: 100%;">Select Owner</button>
                        </div>
                    </div>

                    <div class="admin-bypass">
                        <span style="cursor: pointer;" onclick="document.getElementById('bypassInput').classList.toggle('visible')">Admin Bypass</span>
                        <div id="bypassInput" class="bypass-input">
                            <input type="password" id="adminCode" placeholder="Enter Admin Code" style="width: 200px; display: inline-block;">
                            <button class="btn" style="padding: 0.5rem 1rem;" onclick="applyBypass()">Unlock</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DASHBOARD CONTAINER (Hidden initially) -->
        <div id="dashboard-container" style="display: none;">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2>üìä Command Center</h2>
                    <div id="license-badge" style="padding: 0.5rem 1rem; background: rgba(0, 255, 136, 0.1); border: 1px solid var(--primary); border-radius: 20px; color: var(--primary);">
                        Checking License...
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-label">Status</div>
                        <div class="metric-val" id="status-val">Active</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Active Agents</div>
                        <div class="metric-val" id="agents-val">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Revenue Today</div>
                        <div class="metric-val" id="revenue-today">$0.00</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Your Share</div>
                        <div class="metric-val" id="user-share">$0.00</div>
                    </div>
                </div>

                <br><br>
                <h3>Active Businesses</h3>
                <div id="active-business-list" style="margin-top: 1rem;">
                    Loading...
                </div>
            </div>
        </div>

    </div>

    <script>
        // API Base URL
        const API = 'http://localhost:8000/api';

        // State
        let currentStep = 1;

        // Initialization
        async function init() {
            // Check if already onboarded/licensed
            try {
                const res = await fetch(`${API}/dashboard`);
                const data = await res.json();
                if (data.license && data.license.active) {
                    showDashboard(data);
                }
            } catch (e) {
                console.log("Not onboarded yet or server down");
            }
        }
        init();

        // Navigation
        function nextStep(step) {
            // Update UI
            document.querySelector('.step-indicator.active').classList.add('completed');
            document.querySelector('.step-indicator.active').classList.remove('active');
            document.getElementById(`ind-${step}`).classList.add('active');

            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');

            currentStep = step;
        }

        // Step 1: Profile
        async function submitProfile() {
            const profile = {
                name: document.getElementById('founderName').value,
                location_state: document.getElementById('locationState').value,
                preferred_industry: document.getElementById('preferredIndustry').value,
                weekly_hours: parseInt(document.getElementById('weeklyHours').value),
                startup_budget: parseFloat(document.getElementById('startupBudget').value),
                risk_posture: "balanced" // simplified for UI
            };

            if (!profile.name || !profile.location_state) {
                alert("Please complete all required fields.");
                return;
            }

            try {
                await fetch(`${API}/onboarding`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(profile)
                });
                nextStep(2);
            } catch (e) {
                alert("Error connecting to server.");
            }
        }

        // Step 2: Legal
        function toggleStep2Btn() {
            document.getElementById('btn-step-2').disabled = !document.getElementById('einConfirmed').checked;
        }

        // Step 4: Research
        async function startResearch() {
            document.getElementById('btn-research').disabled = true;
            document.getElementById('osintLog').innerHTML += "> Contacting local registry...<br>";

            // Start simulation on server
            const res = await fetch(`${API}/research`);
            const data = await res.json();

            // Simulate log streaming
            const logs = data.logs;
            const logDiv = document.getElementById('osintLog');
            const progress = document.getElementById('researchProgress');

            let i = 0;
            const interval = setInterval(() => {
                if (i >= logs.length) {
                    clearInterval(interval);
                    progress.style.width = '100%';
                    setTimeout(() => {
                        loadRecommendations();
                        nextStep(5);
                    }, 1000);
                    return;
                }
                logDiv.innerHTML += `> ${logs[i]}<br>`;
                logDiv.scrollTop = logDiv.scrollHeight;
                progress.style.width = `${((i+1)/logs.length)*90}%`;
                i++;
            }, 800);
        }

        // Step 5: Recommendations
        async function loadRecommendations() {
            const res = await fetch(`${API}/recommendations`);
            const ideas = await res.json();

            const container = document.getElementById('recommendations-list');
            container.innerHTML = ideas.map(idea => `
                <div class="business-option" onclick="selectBusiness(this, '${idea.name}')">
                    <h3 style="color: var(--primary)">${idea.name}</h3>
                    <p style="font-size: 0.9rem; color: var(--text-dim);">${idea.industry}</p>
                    <p style="margin: 0.5rem 0;">${idea.description}</p>
                    <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: var(--text-dim);">
                        <span>üí∞ Rev: $${idea.expected_monthly_revenue}/mo</span>
                        <span>üöÄ Cost: $${idea.startup_cost}</span>
                        <span>‚è± ${idea.time_commitment_hours_per_week}h/week</span>
                    </div>
                </div>
            `).join('');
        }

        function selectBusiness(el, name) {
            document.querySelectorAll('.business-option').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selectedBusiness').value = name;
            document.getElementById('btn-select').disabled = false;
        }

        // Step 6: Licensing
        async function selectTier(tier) {
            const businessName = document.getElementById('selectedBusiness').value;

            // First save business selection
            await fetch(`${API}/select-business`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ business_name: businessName })
            });

            if (tier === 'partner') {
                if (!confirm("Confirm Partner Tier?\n\n- 50% Revenue Share\n- NO switching later allowed\n- Instant Setup")) return;
            }

            try {
                const res = await fetch(`${API}/license`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ tier: tier })
                });

                if (!res.ok) throw await res.json();

                // Success - reload to show dashboard
                window.location.reload();
            } catch (e) {
                alert("Error: " + (e.detail || "Setup failed"));
            }
        }

        async function applyBypass() {
            const code = document.getElementById('adminCode').value;
            try {
                const res = await fetch(`${API}/admin-bypass`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code: code })
                });
                if (res.ok) {
                    alert("Admin Bypass Successful! Unlocked Owner Tier.");
                    window.location.reload();
                } else {
                    alert("Invalid Code");
                }
            } catch (e) {
                alert("Error applying code");
            }
        }

        // Dashboard
        function showDashboard(data) {
            document.getElementById('wizard-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';

            // Populate dashboard
            const lic = data.license;
            const badge = document.getElementById('license-badge');

            if (lic.tier === 'partner') {
                badge.innerText = `Partner Tier (${lic.revenue_share_percentage * 100}% Rev Share)`;
                badge.style.borderColor = 'var(--secondary)';
                badge.style.color = 'var(--secondary)';
            } else {
                badge.innerText = "Owner Tier (100% Equity)";
            }

            document.getElementById('status-val').innerText = data.status;
            document.getElementById('agents-val').innerText = data.agents_active;
            document.getElementById('revenue-today').innerText = `$${data.revenue_today}`;
            document.getElementById('user-share').innerText = `$${data.user_share}`;

            document.getElementById('active-business-list').innerHTML = `
                <div class="card" style="border: 1px solid var(--primary); background: rgba(0,255,136,0.05);">
                    <h3>${data.business_name}</h3>
                    <p style="color: var(--success);">‚óè Systems Operational</p>
                </div>
            `;
        }

    </script>
</body>
</html>
