# Copyright (c) 2025 Joshua Hendricks Cole (DBA: Corporation of Light). All Rights Reserved. PATENT PENDING.
#
# Million-Business Autoscaling Infrastructure
# Supports up to 1,000,000 concurrent businesses with fiber-gig performance

---
apiVersion: v1
kind: Namespace
metadata:
  name: bbb-hyperscale
  labels:
    name: bbb-hyperscale
    tier: production
    scale: million-plus

---
# Cluster Autoscaler Configuration for Multi-Region
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-autoscaler-config
  namespace: bbb-hyperscale
data:
  # Scale aggressively for million-business deployment
  scale-down-delay-after-add: "1m"
  scale-down-unneeded-time: "2m"
  scale-down-utilization-threshold: "0.5"
  max-node-provision-time: "3m"
  balance-similar-node-groups: "true"
  skip-nodes-with-local-storage: "false"

  # Regional distribution for 1M businesses
  regions: |
    us-east-1,us-west-2,eu-west-1,ap-southeast-1,ap-northeast-1

---
# Business Processing Queue - High-throughput message bus
apiVersion: apps/v1
kind: Deployment
metadata:
  name: business-queue-processor
  namespace: bbb-hyperscale
spec:
  replicas: 100  # Start with 100, autoscale to 10,000
  selector:
    matchLabels:
      app: business-queue
  template:
    metadata:
      labels:
        app: business-queue
    spec:
      containers:
      - name: queue-processor
        image: bbb/business-processor:latest
        env:
        - name: QUEUE_BATCH_SIZE
          value: "1000"  # Process 1000 businesses per batch
        - name: MAX_CONCURRENT_WORKERS
          value: "50"
        - name: ENABLE_FIBER_MODE
          value: "true"  # Ultra-fast processing
        resources:
          requests:
            memory: "1Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "4000m"

---
# Horizontal Pod Autoscaler for Million-Business Scale
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: business-queue-hpa
  namespace: bbb-hyperscale
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: business-queue-processor
  minReplicas: 100
  maxReplicas: 10000  # Can scale to 10,000 pods for 1M businesses
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 60
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 70
  - type: Pods
    pods:
      metric:
        name: queue_depth
      target:
        type: AverageValue
        averageValue: "100"  # Scale up when queue depth > 100 per pod
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 0  # Scale up immediately
      policies:
      - type: Percent
        value: 900  # Can grow 10x instantly
        periodSeconds: 10
      - type: Pods
        value: 1000  # Add up to 1000 pods at once
        periodSeconds: 10
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60

---
# Sharded Database Architecture for Million-Business Storage
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres-shard
  namespace: bbb-hyperscale
spec:
  serviceName: postgres-shard
  replicas: 50  # 50 database shards, each handling 20K businesses
  selector:
    matchLabels:
      app: postgres-shard
  template:
    metadata:
      labels:
        app: postgres-shard
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        env:
        - name: POSTGRES_USER
          value: bbb_user
        - name: POSTGRES_DB
          value: bbb_shard
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: password
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            memory: "8Gi"
            cpu: "4000m"
          limits:
            memory: "16Gi"
            cpu: "8000m"
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 500Gi  # 500GB per shard

---
# Business Creation API - Handles mass deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: business-creation-api
  namespace: bbb-hyperscale
spec:
  replicas: 50
  selector:
    matchLabels:
      app: business-creation-api
  template:
    metadata:
      labels:
        app: business-creation-api
    spec:
      containers:
      - name: api
        image: bbb/business-creation-api:latest
        env:
        - name: MAX_BATCH_SIZE
          value: "10000"  # Create 10K businesses per API call
        - name: ENABLE_EIN_BYPASS
          value: "true"  # For 5-gig businesses
        - name: AUTO_FOLD_INACTIVE
          value: "true"  # Auto-fold businesses after inactivity
        - name: SHARD_COUNT
          value: "50"
        ports:
        - containerPort: 8000
        resources:
          requests:
            memory: "2Gi"
            cpu: "2000m"
          limits:
            memory: "8Gi"
            cpu: "8000m"

---
# HPA for Business Creation API
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: business-creation-hpa
  namespace: bbb-hyperscale
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: business-creation-api
  minReplicas: 50
  maxReplicas: 1000
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 65
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: "100"

---
# Redis Cluster for High-Speed Caching
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-cluster
  namespace: bbb-hyperscale
spec:
  serviceName: redis-cluster
  replicas: 30  # 30-node Redis cluster
  selector:
    matchLabels:
      app: redis-cluster
  template:
    metadata:
      labels:
        app: redis-cluster
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        command:
        - redis-server
        - --cluster-enabled
        - "yes"
        - --cluster-config-file
        - /data/nodes.conf
        - --cluster-node-timeout
        - "5000"
        - --maxmemory
        - "8gb"
        - --maxmemory-policy
        - allkeys-lru
        ports:
        - containerPort: 6379
          name: client
        - containerPort: 16379
          name: gossip
        volumeMounts:
        - name: redis-data
          mountPath: /data
        resources:
          requests:
            memory: "10Gi"
            cpu: "2000m"
          limits:
            memory: "12Gi"
            cpu: "4000m"
  volumeClaimTemplates:
  - metadata:
      name: redis-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 100Gi

---
# Load Balancer Service for Business Creation API
apiVersion: v1
kind: Service
metadata:
  name: business-creation-lb
  namespace: bbb-hyperscale
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
spec:
  type: LoadBalancer
  ports:
  - port: 443
    targetPort: 8000
    protocol: TCP
    name: https
  selector:
    app: business-creation-api

---
# Network Policy - Allow internal cluster communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-internal
  namespace: bbb-hyperscale
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: bbb-hyperscale
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: bbb-hyperscale

---
# Priority Class for Critical Business Operations
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: business-critical
value: 1000000
globalDefault: false
description: "Priority class for business creation and revenue operations"

---
# Pod Disruption Budget - Ensure high availability during scaling
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: business-api-pdb
  namespace: bbb-hyperscale
spec:
  minAvailable: 40  # Always keep at least 40 pods available
  selector:
    matchLabels:
      app: business-creation-api

---
# Vertical Pod Autoscaler - Optimize resource allocation
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: business-queue-vpa
  namespace: bbb-hyperscale
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: business-queue-processor
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
    - containerName: queue-processor
      minAllowed:
        cpu: 500m
        memory: 1Gi
      maxAllowed:
        cpu: 8000m
        memory: 16Gi
